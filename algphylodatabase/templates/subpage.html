{% extends "base.html" %}
{% block content %}
<div class="topheader">Details: {{ data.treename }} tree with {{data.modelname}} model ({{ treeandmodel_id }})</div>

<div class="main">

    <p style="text-align:left;">Download data for this tree and model: 
    <a href="../static/data/{{ treeandmodel_id }}.yaml" download>
            <button style="background-color:var(--shade-main-color); color:var(--main-color); border: none; border-radius: 5px;cursor: pointer;">{{ treeandmodel_id }}.yaml</button></a>.
    The files phylogeneticmodel_{{ treeandmodel_id }}.mrdi and invariants_{{ treeandmodel_id }}.mrdi for use in Julia/OSCAR will be available with the upcoming release mid November 2025.</p>

<div class="grid-container">
    {% if picture %}
    <div class="module span-3">
        <div id="title">Phylogenetic tree {{ tree_id }}
            <button class="copyBtn" data-file="../static/tex/tex_{{ tree_id }}.yaml" data-key="imagelabelled" 
            style="float: right; background-color:var(--shade-main-color); color:var(--main-color); border: none; border-radius: var(--line-thickness);cursor: pointer;">.tikz</i></button>
            <div id="notification">
            Copied to clipboard!
            </div>
        </div>
        <div id="picture">
            <img src="../static/tex/imagelabelled_{{ tree_id }}.svg" alt="{{ tree_id }}" style="height:75%;">
            <!-- <script type="text/tikz">{{ picture.imagelabelled }}</script>-->
        </div>
    </div>
    {% endif %}

    {% if data.details.transition_matrix %}
    <div class="module span-1">
        <div id="title">
            Evolutionary model
            <button id="copy-evolutionary-model" style="float: right; background-color:var(--shade-main-color); color:var(--main-color); border: none; border-radius: var(--line-thickness);cursor: pointer;"
                data-modelname="{{ data.modelname }}"
                data-root-distribution="{{ data.details.root_distributon }}"
                data-transition-matrix="{{ data.details.transition_matrix }}"
                data-fourier-parameters="{{ data.details.fourier_parameters }}">
                .tex 
            </button>
        </div>
        <div id="content"><a href="/notation#models">{{ data.modelname }}</a> model with <a href="/notation#labelling">root distribution</a> {{ data.details.root_distributon }}. <br>
            The <a href="/notation#labelling">transition matrix</a>  associated with edge $i$ is of the form
            {{ data.details.transition_matrix }} and the <a href="/notation#labelling">Fourier parameters</a> are {{ data.details.fourier_parameters }} for all edges $i$.
        </div>
    </div>
    {% endif %}
    <div id="notification">
        Copied to clipboard!
    </div>
    <script>
        // copy button for this div only!
        const evolutionaryModelButton = document.getElementById('copy-evolutionary-model');
        evolutionaryModelButton.addEventListener('click', async function() {
            try {
        // Retrieve data attributes from the button
        const modelName = this.getAttribute('data-modelname');
        const rootDistribution = this.getAttribute('data-root-distribution');
        const transitionMatrix = this.getAttribute('data-transition-matrix');
        const fourierParameters = this.getAttribute('data-fourier-parameters');

        const textToCopy = `${modelName} model with root distribution ${rootDistribution}.
        The transition matrix associated with edge  $i$  is of the form 
        ${transitionMatrix} 
        and the Fourier parameters are ${fourierParameters} for all edges $i$.`;

            await navigator.clipboard.writeText(textToCopy);

        // Show notification
        notification.style.display = 'block';

        // Hide notification after 3 seconds
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
            } catch (err) {
            console.error('Failed to copy text:', err);
            }
        
    });
    </script>

    {% if data.treename %}
    <div class="module span-3">
        <div id="title">Summary</div>
        <div id="content">
            <a href="/notation#invariants">Dimension:</a>  {{ data.dim }} <br>
            Degree: {{ data.deg }} <br>
            Probability coordinates: {{ data.np }} <br>
            Fourier coordinates: {{ data.nq }} <br>
            dim of Singular locus: {{ data.sd }} <br>
            deg of Singular locus: {{ data.sD }} <br>
            MLdeg: {{ data.MLdeg }} <br>
            EDdeg: {{ data.EDdeg }} <br>
        </div>
    </div>
    {% endif %}


    {% if data.details.probability_parametrization %}
    <div class="module span-1">
        <div id="title">Probability parametrization
            <button class="copyBtn" data-file="../static/data/{{ treeandmodel_id }}.yaml" data-key="details.probability_parametrization" 
            style="float: right; background-color:var(--shade-main-color); color:var(--main-color); border: none; border-radius: var(--line-thickness);cursor: pointer;">.tex</i></button>
            <div id="notification">
            Copied to clipboard!
            </div>
        </div>
        <div id="content">{{ data.details.probability_parametrization | safe }}</div>
    </div>
    {% endif %}

    {% if data.details.fourier_parametrization %}
    <div class="module span-1">
        <div id="title">Fourier parametrization
            <button class="copyBtn" data-file="../static/data/{{ treeandmodel_id }}.yaml" data-key="details.fourier_parametrization" 
            style="float: right; background-color:var(--shade-main-color); color:var(--main-color); border: none; border-radius: var(--line-thickness);cursor: pointer;">.tex</i></button>
            <div id="notification">
            Copied to clipboard!
            </div>
        </div>
        <div id="content">{{ data.details.fourier_parametrization }}</div>
    </div>
    {% endif %}

    {% if data.details.equivalent_classes_prob %}
    <div class="module span-1">
        <div id="title">Equivalent classes of probability parametrization
            <button class="copyBtn" data-file="../static/data/{{ treeandmodel_id }}.yaml" data-key="details.equivalent_classes_prob" 
            style="float: right; background-color:var(--shade-main-color); color:var(--main-color); border: none; border-radius: var(--line-thickness);cursor: pointer;">.tex</i></button>
            <div id="notification">
            Copied to clipboard!
            </div>
        </div>
        <div id="content">{{ data.details.equivalent_classes_prob | safe }}</div>
    </div>
    {% endif %}

    {% if data.details.equivalent_classes_fourier %}
    <div class="module span-1">
        <div id="title">Equivalent classes of Fourier parametrization
            <button class="copyBtn" data-file="../static/data/{{ treeandmodel_id }}.yaml" data-key="details.equivalent_classes_fourier" 
            style="float: right; background-color:var(--shade-main-color); color:var(--main-color); border: none; border-radius: var(--line-thickness);cursor: pointer;">.tex</i></button>
            <div id="notification">
            Copied to clipboard!
            </div>
        </div>
        <div id="content">{{ data.details.equivalent_classes_fourier }}</div>
    </div>
    {% endif %}

    <!--
    {% if data.details.equivalent_classes_prob %}
    <div class="module span-1">
        <div id="title">Reparametrization probability to Fourier coordinates</div>
        <div id="content">THERE WILL BE NEW TEXT HERE{{ data.details.equivalent_classes_prob | safe }}</div>
    </div>
    {% endif %}

    {% if data.details.equivalent_classes_fourier %}
    <div class="module span-1">
        <div id="title">Reparametrization Fourier to probability coordinates</div>
        <div id="content">THERE WILL BE NEW TEXT HERE{{ data.details.equivalent_classes_fourier }}</div>
    </div>
    {% endif %}
    -->

    {% if data.details.invariants %}
    <div class="module span-1">
        <div id="title">Invariants in Fourier coordinates
            <button class="copyBtn" data-file="../static/data/{{ treeandmodel_id }}.yaml" data-key="details.invariants" 
            style="float: right; background-color:var(--shade-main-color); color:var(--main-color); border: none; border-radius: var(--line-thickness);cursor: pointer;">.tex</i></button>
            <div id="notification">
            Copied to clipboard!
            </div>
        </div>
        <div id="content">{{ data.details.invariants }}</div>
    </div>
    {% endif %}

    {% if data.details.grobner_basis %}
    <div class="module span-1">
        <div id="title">Gröbner basis of ideal of invariants
            <button class="copyBtn" data-file="../static/data/{{ treeandmodel_id }}.yaml" data-key="details.grobner_basis" 
            style="float: right; background-color:var(--shade-main-color); color:var(--main-color); border: none; border-radius: var(--line-thickness);cursor: pointer;">.tex</i></button>
            <div id="notification">
            Copied to clipboard!
            </div>
        </div>
        <div id="content">{{ data.details.grobner_basis }}</div>
    </div>
    {% endif %}

    {% if data.mu %}
    <div class="module span-2">
        <div id="title">Additional information</div>
        <div id="content">
            The cardinality of the smallest set of generators that define the ideal of phylogenetic invariants: {{ data.mu }} <br>
            The largest degree of a generator in the degree reverse lexicographic reduced Gröbner basis: {{ data.E }} <br>
            The largest degree of an element in a minimal generating set for the ideal of phylogenetic invariants: {{ data.e }} <br>
            The cardinality of the degree reverse lexicographic reduced Gröbner basis of the ideal of phylogenetic invariants: {{ data.M }}
        </div>
    </div>
    {% endif %}

    {% if data.details.specialized_fourier_transform %}
    <div class="module span-3">
        <div id="title">Specialized Fourier transform
            <button class="copyBtn" data-file="../static/data/{{ treeandmodel_id }}.yaml" data-key="details.specialized_fourier_transform" 
            style="float: right; background-color:var(--shade-main-color); color:var(--main-color); border: none; border-radius: var(--line-thickness);cursor: pointer;">.tex</i></button>
            <div id="notification">
            Copied to clipboard!
            </div>
        </div>
        <div id="content">{{ data.details.specialized_fourier_transform }}</div>
    </div>
    {% endif %}

    {% if data.details.inverse_specialized_fourier_transform %}
    <div class="module span-3">
        <div id="title">Inverse specialized Fourier transform
            <button class="copyBtn" data-file="../static/data/{{ treeandmodel_id }}.yaml" data-key="details.inverse_specialized_fourier_transform"
            style="float: right; background-color:var(--shade-main-color); color:var(--main-color); border: none; border-radius: var(--line-thickness);cursor: pointer;">.tex</i></button>
            <div id="notification">
            Copied to clipboard!
            </div>
        </div>
        <div id="content">{{ data.details.inverse_specialized_fourier_transform }}</div>
    </div>
    {% endif %}
</div>
</div>

<script>
  // Helper function: safely access nested keys like "a.b.c"
  function getNestedValue(obj, path) {
    return path.split('.').reduce((acc, key) => (acc && acc[key] !== undefined) ? acc[key] : undefined, obj);
  }

  document.querySelectorAll('.copyBtn').forEach(button => {
    button.addEventListener('click', async function() {
      const filePath = this.getAttribute('data-file'); // e.g., "data1.yaml"
      const keyPath = this.getAttribute('data-key');   // e.g., "settings.theme.color"

      try {
        // Fetch YAML file
        const response = await fetch(filePath);
        if (!response.ok) throw new Error(`File not found: ${filePath}`);

        // Parse YAML
        const yamlText = await response.text();
        const yamlData = jsyaml.load(yamlText);

        // Get nested key value
        const value = getNestedValue(yamlData, keyPath);
        if (value === undefined) throw new Error(`Key "${keyPath}" not found in ${filePath}`);

        // Convert to string for copying
        const copyText = typeof value === 'object'
          ? JSON.stringify(value, null, 2)
          : String(value);

        // Copy to clipboard
        await navigator.clipboard.writeText(copyText);

        document.getElementById('status').textContent = `✅ Copied "${keyPath}" from ${filePath}!`;
      } catch (error) {
        console.error(error);
        document.getElementById('status').textContent = `❌ ${error.message}`;
      }
    });
  });
</script>

{% endblock %}